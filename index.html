<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8" />
    <title>Copoint – ID + Selfie Capture Wizard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --primary: #3b82f6;
            --accent: #22d3ee;
            --success: #10b981;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
        }

        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            color: var(--text-main);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            padding: 16px 20px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        header h1 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.02em;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #status {
            font-size: 12px;
            color: var(--accent);
            font-weight: 500;
        }

        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 16px;
            gap: 16px;
            position: relative;
        }

        #step-indicator {
            font-size: 14px;
            color: var(--text-sub);
            font-weight: 500;
        }

        #video-container {
            position: relative;
            max-width: 400px;
            width: 100%;
            aspect-ratio: 3/4;
            border-radius: 24px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        /* Çerçeve Rehberi (ID) */
        #frame-guide {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 90%;
            height: 55%;
            /* Biraz daha geniş */
            transform: translate(-50%, -50%);
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Köşe çizgileri (Viewfinder effect) */
        #frame-guide::before,
        #frame-guide::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: var(--primary);
            border-style: solid;
            transition: all 0.3s ease;
        }

        #frame-guide::before {
            top: 0;
            left: 0;
            border-width: 3px 0 0 3px;
            border-radius: 4px 0 0 0;
        }

        #frame-guide::after {
            bottom: 0;
            right: 0;
            border-width: 0 3px 3px 0;
            border-radius: 0 0 4px 0;
        }

        /* Tarama Animasyonu */
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary);
            top: 0;
            animation: scan 2.5s ease-in-out infinite;
            opacity: 0.8;
        }

        @keyframes scan {
            0% {
                top: 0;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        /* Selfie Çemberi */
        #selfie-circle {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 80%;
            aspect-ratio: 1/1;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 2px dashed rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
            display: none;
        }

        #hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            text-align: center;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            padding: 8px 16px;
            border-radius: 99px;
            font-size: 13px;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #debug-rect {
            position: absolute;
            border: 2px solid var(--success);
            border-radius: 8px;
            pointer-events: none;
            display: none;
            transition: all 0.1s linear;
        }

        #controls {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 400px;
            justify-content: center;
        }

        button {
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            outline: none;
        }

        #manual-btn {
            background: var(--primary);
            color: #fff;
            flex: 2;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        #manual-btn:hover {
            background: #2563eb;
        }

        #manual-btn:active {
            transform: scale(0.98);
        }

        #restart-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-sub);
            flex: 1;
        }

        #restart-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        #next-step-btn {
            display: none;
        }

        button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        #preview-wrapper {
            width: 100%;
            max-width: 400px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: auto;
        }

        .preview-card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100px;
            position: relative;
        }

        .preview-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.4;
            transition: opacity 0.3s;
        }

        .preview-card.filled img {
            opacity: 1;
        }

        .preview-card div {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.6);
            font-size: 10px;
            padding: 4px 0;
            text-align: center;
            color: #ccc;
            backdrop-filter: blur(4px);
        }

        #submit-btn {
            width: 100%;
            max-width: 400px;
            background: var(--success);
            color: #fff;
            font-weight: 600;
            padding: 14px;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        #version-tag {
            position: fixed;
            bottom: 6px;
            right: 8px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.2);
            font-family: monospace;
            z-index: 100;
        }

        canvas {
            display: none;
        }
    </style>

    <!-- OpenCV.js -->
    <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
</head>

<body>

    <header>
        <h1>Copoint Capture</h1>
        <div id="status">Başlatılıyor…</div>
    </header>

    <div id="main">
        <div id="step-indicator">Kimlik Ön Yüz</div>

        <div id="video-container">
            <video id="video" autoplay playsinline></video>
            <div id="overlay">
                <div id="frame-guide">
                    <div class="scan-line"></div>
                </div>
                <div id="selfie-circle"></div>
                <div id="hint">Lütfen kimliği çerçevenin içinde tutun</div>
                <div id="debug-rect"></div>
            </div>
        </div>

        <div id="controls">
            <button id="restart-btn" disabled>Tekrar</button>
            <button id="manual-btn" disabled>Manuel</button>
            <button id="next-step-btn" style="display:none">İleri</button>
        </div>

        <div id="preview-wrapper">
            <div class="preview-card" id="card-front">
                <img id="preview-front" />
                <div>Ön</div>
            </div>
            <div class="preview-card" id="card-back">
                <img id="preview-back" />
                <div>Arka</div>
            </div>
            <div class="preview-card" id="card-selfie">
                <img id="preview-selfie" />
                <div>Selfie</div>
            </div>
        </div>

        <button id="submit-btn" disabled>Onayla ve Gönder</button>
        <div id="version-tag">v1.3</div>
    </div>

    <canvas id="process-canvas"></canvas>
    <canvas id="capture-canvas"></canvas>

    <script>
        const video = document.getElementById("video");
        const statusEl = document.getElementById("status");
        const stepIndicator = document.getElementById("step-indicator");
        const hintEl = document.getElementById("hint");
        const frameGuide = document.getElementById("frame-guide");
        const selfieCircle = document.getElementById("selfie-circle");

        // Preview Cards
        const cardFront = document.getElementById("card-front");
        const cardBack = document.getElementById("card-back");
        const cardSelfie = document.getElementById("card-selfie");

        const processCanvas = document.getElementById("process-canvas");
        const processCtx = processCanvas.getContext("2d", { willReadFrequently: true });

        const captureCanvas = document.getElementById("capture-canvas");
        const captureCtx = captureCanvas.getContext("2d");

        const debugRect = document.getElementById("debug-rect");

        const restartBtn = document.getElementById("restart-btn");
        const manualBtn = document.getElementById("manual-btn");
        const nextStepBtn = document.getElementById("next-step-btn");
        const submitBtn = document.getElementById("submit-btn");

        const previewFront = document.getElementById("preview-front");
        const previewBack = document.getElementById("preview-back");
        const previewSelfie = document.getElementById("preview-selfie");

        let stream = null;
        let processing = false;
        let captured = false;
        let cvReady = false;

        // Wizard state
        const steps = ["id_front", "id_back", "selfie"];
        let currentStepIndex = 0;

        let frontImage = null;
        let backImage = null;
        let selfieImage = null;

        // Auto Capture Settings
        let stableFrames = 0;
        const REQUIRED_STABLE_FRAMES = 2; // Hızlı
        const BLUR_THRESHOLD = 15.0; // Toleranslı
        const MIN_CARD_AREA_RATIO = 0.15;

        let lastRect = null;

        function updateUIForStep() {
            const step = steps[currentStepIndex];

            const labels = {
                id_front: "1. Adım: Kimlik Ön Yüz",
                id_back: "2. Adım: Kimlik Arka Yüz",
                selfie: "3. Adım: Selfie"
            };

            const hints = {
                id_front: "Kimliği dikdörtgenin içine yerleştirin.",
                id_back: "Kimliğin arka yüzünü çevirin.",
                selfie: "Yüzünüzü dairenin içine alın."
            };

            stepIndicator.textContent = labels[step];
            hintEl.textContent = hints[step];

            const isSelfie = step === "selfie";
            frameGuide.style.display = isSelfie ? "none" : "block";
            selfieCircle.style.display = isSelfie ? "block" : "none";

            manualBtn.disabled = !cvReady;
            restartBtn.disabled = true;

            // Highlight active card
            [cardFront, cardBack, cardSelfie].forEach(c => c.style.border = "1px solid rgba(255,255,255,0.05)");
            if (step === "id_front") cardFront.style.border = "1px solid var(--primary)";
            if (step === "id_back") cardBack.style.border = "1px solid var(--primary)";
            if (step === "selfie") cardSelfie.style.border = "1px solid var(--primary)";

            if (isSelfie) {
                statusEl.textContent = "Hazır";
            } else {
                statusEl.textContent = "Aranıyor...";
            }
        }

        function onOpenCvReady() {
            cvReady = true;
            statusEl.textContent = "Kamera Başlatılıyor...";
            initCamera();
        }

        if (typeof cv !== "undefined") {
            cv["onRuntimeInitialized"] = onOpenCvReady;
        } else {
            window.Module = {
                onRuntimeInitialized: onOpenCvReady
            };
        }

        setTimeout(() => {
            if (!cvReady) {
                statusEl.textContent = "Hata: OpenCV Modülü Yüklenemedi.";
                statusEl.style.color = "var(--accent)";
            }
        }, 15000);

        async function initCamera() {
            try {
                const step = steps[currentStepIndex];
                const isSelfie = step === "selfie";

                const constraints = {
                    video: {
                        facingMode: isSelfie ? "user" : "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                if (stream) {
                    stream.getTracks().forEach(t => t.stop());
                }

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                if (isSelfie) {
                    video.style.transform = "scaleX(-1)";
                } else {
                    video.style.transform = "scaleX(1)";
                }

                video.onloadedmetadata = () => {
                    setupCanvasSize();
                    captured = false;
                    updateUIForStep();
                    startProcessingLoop();
                };
            } catch (err) {
                console.error(err);
                statusEl.textContent = "Kamera hatası: " + err.message;
            }
        }

        function setupCanvasSize() {
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            const width = vw || 640;
            const height = vh || 480;

            processCanvas.width = width;
            processCanvas.height = height;
            captureCanvas.width = width;
            captureCanvas.height = height;
        }

        function startProcessingLoop() {
            if (processing || !cvReady) return;
            processing = true;
            captured = false;
            stableFrames = 0;
            lastRect = null;
            hideDebugRect();

            const FPS = 12;
            const interval = 1000 / FPS;

            const loop = () => {
                if (!processing) return;
                processFrame();
                setTimeout(loop, interval);
            };
            loop();
        }

        function processFrame() {
            if (!video.videoWidth || !video.videoHeight) return;
            if (captured) return;

            const step = steps[currentStepIndex];
            if (step === "selfie") return;

            processCtx.drawImage(video, 0, 0, processCanvas.width, processCanvas.height);
            const frame = processCtx.getImageData(0, 0, processCanvas.width, processCanvas.height);

            let src = cv.matFromImageData(frame);
            let gray = new cv.Mat();
            let blurred = new cv.Mat();
            let edges = new cv.Mat();

            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
            cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0, 0, cv.BORDER_DEFAULT);
            cv.Canny(blurred, edges, 50, 150);

            let lap = new cv.Mat();
            cv.Laplacian(gray, lap, cv.CV_64F);
            const blurScore = lapVariance(lap);

            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            const bestRect = findBestCardRect(contours, src.cols, src.rows);

            src.delete(); gray.delete(); blurred.delete();
            edges.delete(); lap.delete(); contours.delete(); hierarchy.delete();

            if (bestRect) {
                const { x, y, w, h } = bestRect;
                drawDebugRect(x, y, w, h);
                const areaRatio = (w * h) / (processCanvas.width * processCanvas.height);

                const stable = isStable(bestRect);
                const blurOk = blurScore >= BLUR_THRESHOLD;
                const areaOk = areaRatio >= MIN_CARD_AREA_RATIO;

                if (stable && blurOk && areaOk) {
                    stableFrames++;
                    statusEl.innerHTML = `<span style="color:var(--success)">Yakalandı! Sabit tutun... (${stableFrames}/${REQUIRED_STABLE_FRAMES})</span>`;
                } else {
                    stableFrames = 0;
                    let reason = "";
                    if (!areaOk) reason = "Yaklaşın";
                    else if (!blurOk) reason = "Netleştirin";
                    else if (!stable) reason = "Sabit Tutun";

                    statusEl.innerHTML = `Aranıyor... <span style="color:var(--accent)">${reason}</span>`;
                }

                if (stableFrames >= REQUIRED_STABLE_FRAMES) {
                    autoCapture(bestRect);
                }
            } else {
                hideDebugRect();
                stableFrames = 0;
                statusEl.textContent = "Kimlik Aranıyor...";
            }
        }

        function lapVariance(mat) {
            let data = mat.data64F;
            if (!data || data.length === 0) return 0.0;
            let sum = 0;
            for (let i = 0; i < data.length; i++) sum += data[i];
            const mean = sum / data.length;
            let sqDiff = 0;
            for (let i = 0; i < data.length; i++) {
                const diff = data[i] - mean;
                sqDiff += diff * diff;
            }
            return sqDiff / data.length;
        }

        function findBestCardRect(contours, width, height) {
            let best = null;
            let bestArea = 0;

            for (let i = 0; i < contours.size(); i++) {
                const cnt = contours.get(i);
                const area = cv.contourArea(cnt);
                if (area < (width * height * 0.05)) continue;

                const peri = cv.arcLength(cnt, true);
                const approx = new cv.Mat();
                cv.approxPolyDP(cnt, approx, 0.02 * peri, true);

                if (approx.rows === 4) {
                    const rect = cv.boundingRect(approx);
                    const rArea = rect.width * rect.height;
                    const ratio = rect.width / rect.height;
                    if (ratio < 1.3 || ratio > 1.9) {
                        approx.delete();
                        continue;
                    }
                    if (rArea > bestArea) {
                        bestArea = rArea;
                        best = rect;
                    }
                }
                approx.delete();
            }
            if (!best) return null;
            return { x: best.x, y: best.y, w: best.width, h: best.height };
        }

        function drawDebugRect(x, y, w, h) {
            const container = document.getElementById("video-container");
            const cw = container.clientWidth;
            const ch = container.clientHeight;
            const scaleX = cw / processCanvas.width;
            const scaleY = ch / processCanvas.height;

            debugRect.style.display = "block";
            debugRect.style.left = (x * scaleX) + "px";
            debugRect.style.top = (y * scaleY) + "px";
            debugRect.style.width = (w * scaleX) + "px";
            debugRect.style.height = (h * scaleY) + "px";
        }

        function hideDebugRect() {
            debugRect.style.display = "none";
        }

        function isStable(rect) {
            if (!lastRect) {
                lastRect = rect;
                return false;
            }
            const dx = Math.abs(rect.x - lastRect.x);
            const dy = Math.abs(rect.y - lastRect.y);
            const dw = Math.abs(rect.w - lastRect.w);
            const dh = Math.abs(rect.h - lastRect.h);

            lastRect = rect;
            return dx < 20 && dy < 20 && dw < 20 && dh < 20;
        }

        function autoCapture(rect) {
            if (captured) return;
            captured = true;
            processing = false;

            statusEl.innerHTML = "<span style='color:var(--success)'>Mükemmel! ✅</span>";
            hintEl.textContent = "Alındı, diğer adıma geçiliyor...";

            captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
            const { x, y, w, h } = rect;
            const cropped = captureCtx.getImageData(x, y, w, h);

            const tmpCanvas = document.createElement("canvas");
            tmpCanvas.width = w;
            tmpCanvas.height = h;
            const tmpCtx = tmpCanvas.getContext("2d");
            tmpCtx.putImageData(cropped, 0, 0);

            const dataUrl = tmpCanvas.toDataURL("image/jpeg", 0.9);
            storeImageForCurrentStep(dataUrl);

            onCaptureSuccess();
        }

        function manualCapture() {
            if (captured) return;
            processing = false;
            captured = true;

            statusEl.innerHTML = "<span style='color:var(--success)'>Manuel Çekim ✅</span>";

            const step = steps[currentStepIndex];
            const isSelfie = step === "selfie";

            if (isSelfie) {
                captureCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
                const dataUrl = captureCanvas.toDataURL("image/jpeg", 0.9);
                storeImageForCurrentStep(dataUrl);
            } else {
                const totalW = captureCanvas.width;
                const totalH = captureCanvas.height;
                const guideW = totalW * 0.90;
                const guideH = totalH * 0.55; // CSS update ile uyumlu
                const guideX = (totalW - guideW) / 2;
                const guideY = (totalH - guideH) / 2;

                captureCtx.drawImage(video, 0, 0, totalW, totalH);
                const cropped = captureCtx.getImageData(guideX, guideY, guideW, guideH);

                const tmpCanvas = document.createElement("canvas");
                tmpCanvas.width = guideW;
                tmpCanvas.height = guideH;
                const tmpCtx = tmpCanvas.getContext("2d");
                tmpCtx.putImageData(cropped, 0, 0);

                const dataUrl = tmpCanvas.toDataURL("image/jpeg", 0.9);
                storeImageForCurrentStep(dataUrl);
            }

            onCaptureSuccess();
        }

        // Capture success logic: Auto Advance
        function onCaptureSuccess() {
            manualBtn.disabled = true;
            restartBtn.disabled = false;

            // 1.5 sn sonra diğer adıma geç
            setTimeout(() => {
                if (currentStepIndex < steps.length - 1) {
                    goToNextStep();
                } else {
                    statusEl.innerHTML = "<span style='color:var(--success)'>Tüm adımlar tamamlandı!</span>";
                    submitBtn.disabled = false;
                }
            }, 1200);
        }

        function storeImageForCurrentStep(dataUrl) {
            const step = steps[currentStepIndex];
            if (step === "id_front") {
                frontImage = dataUrl;
                previewFront.src = dataUrl;
                cardFront.classList.add("filled");
            } else if (step === "id_back") {
                backImage = dataUrl;
                previewBack.src = dataUrl;
                cardBack.classList.add("filled");
            } else if (step === "selfie") {
                selfieImage = dataUrl;
                previewSelfie.src = dataUrl;
                cardSelfie.classList.add("filled");
            }
        }

        function resetCurrentStep() {
            captured = false;
            processing = false;
            stableFrames = 0;
            lastRect = null;
            hideDebugRect();
            manualBtn.disabled = false;
            restartBtn.disabled = true;
            statusEl.textContent = "Hazır mısınız?";
            startProcessingLoop();
        }

        function goToNextStep() {
            if (currentStepIndex < steps.length - 1) {
                currentStepIndex++;
                captured = false;
                processing = false;
                stableFrames = 0;
                lastRect = null;
                hideDebugRect();
                updateUIForStep();
                initCamera();
            }
        }

        async function submitAll() {
            if (!frontImage || !backImage || !selfieImage) return;

            statusEl.innerHTML = "Veriler gönderiliyor...";
            submitBtn.disabled = true;

            const payload = {
                id_front: frontImage.split(",")[1],
                id_back: backImage.split(",")[1],
                selfie: selfieImage.split(",")[1],
                source: "browser_v1.3"
            };

            console.log("Simülasyon Payload:", payload);

            setTimeout(() => {
                statusEl.innerHTML = "<span style='color:var(--success)'>Gönderim Başarılı! ✅</span>";
                submitBtn.textContent = "Tamamlandı";
            }, 1000);
        }

        restartBtn.addEventListener("click", resetCurrentStep);
        manualBtn.addEventListener("click", manualCapture);
        nextStepBtn.addEventListener("click", goToNextStep);
        submitBtn.addEventListener("click", submitAll);
    </script>
</body>

</html>